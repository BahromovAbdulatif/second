<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Админ-панель — Конференции</title>
<style>
  :root{
    --bg:#f3f6fb; --panel:#fff; --ink:#0f172a; --muted:#64748b;
    --brand:#1e66ff; --ring:#c7d7ff; --border:#e5e7eb;
    --shadow:0 8px 18px rgba(2,6,23,.06), 0 2px 6px rgba(2,6,23,.04);
    --radius:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:linear-gradient(180deg,#e9f0ff 0%, #f6f8ff 120%);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;
    font-size:14px; line-height:1.45; color:var(--ink)
  }
  a{color:inherit;text-decoration:none}

  /* Topbar */
  .topbar{position:sticky;top:0;z-index:50;background:rgba(255,255,255,.9);backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid var(--border)}
  .topbar-inner{max-width:1280px;margin:0 auto;display:flex;align-items:center;justify-content:space-between;padding:10px 16px}
  .brand{display:flex;gap:8px;align-items:center;font-weight:800}
  .brand-badge{width:22px;height:22px;border-radius:6px;background:#0b3ea9}
  .tabs{display:flex;gap:6px;flex-wrap:wrap}
  .tab{padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700;color:#1f2a5a;font-size:13px}
  .tab.active{background:#eef2ff;color:#0b3ea9}

  /* Layout */
  .wrap{max-width:1280px;margin:18px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
  .card-head{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid var(--border)}
  .card-title{margin:0;font-size:18px;font-weight:800}
  .card-body{padding:14px}
  .btn{appearance:none;border:0;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer;transition:filter .15s, transform .03s;font-size:13px}
  .btn:active{transform:translateY(1px)}
  .btn.primary{background:var(--brand);color:#fff;box-shadow:0 6px 14px rgba(30,102,255,.18)}
  .btn.ghost{background:#eef2ff;color:#1f2a5a}
  .btn.icon{display:inline-flex;align-items:center;gap:6px}
  .muted{color:var(--muted);font-size:12px}

  /* Table */
  .table-wrap{overflow:auto}
  .table{width:100%;border-collapse:separate;border-spacing:0;min-width:950px}
  .table th,.table td{padding:10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:middle;font-size:13px}
  .table th{color:#334155;background:#f8fafc;font-weight:800}
  .table tr:hover td{background:#fafbff}
  .badge{display:inline-block;padding:3px 7px;border-radius:999px;font-size:11px;background:#eef2ff;color:#0b3ea9;font-weight:800}
  .action-cell{white-space:nowrap}
  .linkish{color:#0b3ea9;cursor:pointer;text-decoration:underline}

  /* Sections */
  .section{display:none}
  .section.active{display:block}

  /* -------- Modal base (GRID + внутренний скролл) -------- */
  .modal-backdrop{
    position: fixed; inset: 0; background: rgba(2,6,23,.5);
    display: none; align-items: center; justify-content: center;
    padding: 12px; z-index: 100;
  }
  .modal-backdrop.show{ display:flex; }
  .modal{
    width: min(1100px, 96vw);
    height: 80dvh;                 /* гарантированный внутренний скролл */
    display: grid; grid-template-rows: auto 1fr auto;
    background:#fff; border-radius:12px; border:1px solid var(--border);
    box-shadow:var(--shadow); overflow:hidden;
  }
  .modal-head{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;background:#0b3ea9;color:#fff}
  .modal-title{margin:0;font-weight:900;font-size:15px}
  .modal-body{overflow:auto;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;padding:12px}
  .modal-actions{display:flex;gap:8px;justify-content:flex-end;padding:10px 12px;border-top:1px solid var(--border);background:#f8fafc}

  /* Create-project form */
  .modal-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .form-row{display:flex;flex-direction:column;gap:6px}
  label{font-size:12px;font-weight:900}
  .req::after{content:" *";color:#ef4444}
  input[type="text"],input[type="date"],input[type="time"],input[type="number"],input[type="tel"],input[type="url"]{
    width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:8px;font:inherit;background:#fff;outline:none;transition:border .15s, box-shadow .15s;font-size:13px
  }
  input:focus{border-color:var(--brand);box-shadow:0 0 0 3px var(--ring)}

  .subcard{border:1px dashed var(--border);border-radius:10px;padding:10px;margin-top:10px}
  .subhead{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
  .row-grid{display:grid;grid-template-columns:1.2fr 1fr .22fr;gap:8px;margin-bottom:8px}
  .row-grid.participants{grid-template-columns:1.2fr 1fr .22fr}
  .remove{background:#fff;border:1px solid var(--border);border-radius:8px;padding:6px;cursor:pointer;font-size:14px}
  .remove:hover{filter:brightness(.98)}

  /* Project View modal */
  .pv-grid{display:grid;grid-template-columns:1fr;gap:10px}
  .pv-2col{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .pv-card{border:1px solid var(--border);border-radius:10px;padding:10px}
  .pv-title{margin:0 0 8px;font-size:14px;font-weight:900}
  .pv-row{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px}
  .pv-row input{width:100%}
  .pv-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
  .ppl-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:8px}
  .ppl-table{width:100%;border-collapse:separate;border-spacing:0;min-width:900px}
  .ppl-table th,.ppl-table td{padding:8px;border-bottom:1px solid var(--border);font-size:12px;text-align:left;vertical-align:middle}
  .ppl-table th{background:#f8fafc;font-weight:900}
  .input-sm{padding:6px 8px;border:1px solid var(--border);border-radius:6px;font-size:12px;width:100%}
  .copy-btn,.regen-btn,.sms-btn{padding:6px 8px;border:1px solid var(--border);border-radius:6px;background:#fff;cursor:pointer;font-size:12px}
  .copy-btn:hover,.regen-btn:hover,.sms-btn:hover{filter:brightness(.98)}

  /* ===== АНАЛИТИКА (как раньше) ===== */
  .bar{display:flex;align-items:center;gap:10px;margin:10px 0}
  .bar-label{width:34%;min-width:180px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:14px}
  .bar-track{flex:1;height:12px;background:#eef2ff;border-radius:999px;overflow:hidden}
  .bar-fill{height:100%;background:linear-gradient(90deg,#4b7bff,#1e66ff);border-radius:999px}
  .bar-value{min-width:90px;text-align:right;font-variant-numeric:tabular-nums;font-size:13px}

  @media(max-width:1100px){ .modal-grid{grid-template-columns:repeat(2,1fr)} }
  @media(max-width:720px){
    .modal{ width:100%; height:100dvh; border-radius:0 }
    .modal-body{ padding:10px }
    .modal-grid{ grid-template-columns:1fr }
    .row-grid,.row-grid.participants{ grid-template-columns:1fr 1fr .22fr }
    .tabs{ gap:4px }
    .pv-2col{grid-template-columns:1fr}
    .pv-row{grid-template-columns:1fr 1fr}
  }
</style>
</head>
<body>

<header class="topbar">
  <div class="topbar-inner">
    <div class="brand"><span class="brand-badge"></span> Admin Panel</div>
    <nav class="tabs" id="tabs">
      <a class="tab active" data-target="sec-home">Главная</a>
      <a class="tab" data-target="sec-analytics">Аналитика</a>
      <a class="tab" data-target="sec-projects">Проекты</a>
      <a class="tab" data-target="sec-people">Участники</a>
      <a class="tab" data-target="sec-settings">Настройки</a>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- Главная -->
  <section id="sec-home" class="section active">
    <div class="card">
      <div class="card-head">
        <h2 class="card-title">Список проектов (конференции)</h2>
        <button class="btn primary icon" id="btn-new">➕ Создать проект</button>
      </div>
      <div class="card-body">
        <div class="table-wrap">
          <table class="table">
            <thead>
              <tr>
                <th>#</th><th>Название</th><th>Даты</th><th>Время</th>
                <th>Сумма</th><th>Компания</th><th>Участники</th><th class="action-cell">Действия</th>
              </tr>
            </thead>
            <tbody id="projects-tbody"></tbody>
          </table>
        </div>
        <p class="muted" style="margin-top:6px">Клик по названию или по ✏️ — открыть проект. Внутри: участники, номера Узбекистана, индивидуальные ссылки (Copy / Regen).</p>
      </div>
    </div>
  </section>

  <!-- Аналитика -->
  <section id="sec-analytics" class="section">
    <div class="card">
      <div class="card-head"><h2 class="card-title">Аналитика</h2></div>
      <div class="card-body">
        <h3 style="margin:6px 0 10px">1) ТОП компаний по метрике (∑оценок / 365 / N)</h3>
        <div id="bars-companies"></div>

        <h3 style="margin:18px 0 10px">2) ТОП спикеров по метрике (∑оценок / 365 / N)</h3>
        <div id="bars-speakers"></div>

        <h3 style="margin:18px 0 10px">3) ТОП проектов по средней оценке</h3>
        <div id="bars-projects"></div>

        <p class="muted">Метрики — демонстрационные. Замените массивы <code>analyticsData</code> реальными данными с бэка.</p>
      </div>
    </div>
  </section>

  <!-- Заглушки -->
  <section id="sec-projects" class="section"><div class="card"><div class="card-head"><h2 class="card-title">Проекты</h2></div><div class="card-body">Фильтры, экспорт — далее.</div></div></section>
  <section id="sec-people"   class="section"><div class="card"><div class="card-head"><h2 class="card-title">Участники</h2></div><div class="card-body">Сводный список участников.</div></div></section>
  <section id="sec-settings" class="section"><div class="card"><div class="card-head"><h2 class="card-title">Настройки</h2></div><div class="card-body">SMS-провайдер, роли и т.д.</div></div></section>
</main>

<!-- Модалка: Создать проект -->
<div class="modal-backdrop" id="modal-create">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title-create">
    <div class="modal-head">
      <h3 class="modal-title" id="modal-title-create">Создать проект (конференцию)</h3>
      <button class="btn ghost" id="close-create" aria-label="Закрыть">✕</button>
    </div>
    <form id="project-form">
      <div class="modal-body">
        <div class="modal-grid">
          <div class="form-row"><label class="req" for="p-name">Название</label><input id="p-name" type="text" placeholder="Design Summit 2025" required></div>
          <div class="form-row"><label class="req" for="p-company">Компания-организатор</label><input id="p-company" type="text" placeholder="BlueWave Events" required></div>
          <div class="form-row"><label class="req" for="p-place">Место / Адрес</label><input id="p-place" type="text" placeholder="г. Ташкент, ул. Навои, 12" required></div>
          <div class="form-row"><label class="req" for="p-manager-phone">Телефон менеджера</label><input id="p-manager-phone" type="tel" inputmode="tel" placeholder="+998 (__) ___-__-__" pattern="^\\+?\\d[\\d\\s\\-()]{6,}$" required></div>
          <div class="form-row"><label class="req" for="p-date-start">Дата начала</label><input id="p-date-start" type="date" required></div>
          <div class="form-row"><label class="req" for="p-date-end">Дата окончания</label><input id="p-date-end" type="date" required></div>
          <div class="form-row"><label class="req" for="p-time-start">Время начала</label><input id="p-time-start" type="time" required></div>
          <div class="form-row"><label class="req" for="p-time-end">Время окончания</label><input id="p-time-end" type="time" required></div>
          <div class="form-row"><label class="req" for="p-amount">Сумма (UZS)</label><input id="p-amount" type="number" min="0" step="1000" placeholder="0" required></div>
          <div class="form-row"><label for="p-status">Статус</label><input id="p-status" type="text" placeholder="Черновик / Опубликован"></div>
        </div>

        <div class="subcard" id="speakers-card">
          <div class="subhead"><strong>Спикеры</strong><button class="btn ghost" type="button" id="add-speaker">+ Добавить спикера</button></div>
          <div id="speakers-list"></div>
          <p class="muted">Имя и тема выступления. Можно добавить несколько.</p>
        </div>

        <div class="subcard" id="participants-card">
          <div class="subhead"><strong>Участники</strong><button class="btn ghost" type="button" id="add-participant">+ Добавить участника</button></div>
          <div id="participants-list"></div>
          <p class="muted">Имя и номер телефона (для SMS с одноразовой ссылкой). Если пропустить — добавим 10–30 демо-участников автоматически.</p>
        </div>
      </div>
      <div class="modal-actions">
        <button type="button" class="btn ghost" id="cancel-create">Отмена</button>
        <button type="submit" class="btn primary">Сохранить проект</button>
      </div>
    </form>
  </div>
</div>

<!-- Модалка: Просмотр/редактирование проекта -->
<div class="modal-backdrop" id="modal-view">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title-view">
    <div class="modal-head">
      <h3 class="modal-title" id="modal-title-view">Проект</h3>
      <button class="btn ghost" id="close-view" aria-label="Закрыть">✕</button>
    </div>
    <div class="modal-body">
      <div class="pv-grid">
        <div class="pv-card">
          <h4 class="pv-title">Обзор проекта</h4>
          <div class="pv-2col">
            <div class="pv-row">
              <input id="pv-name" class="input-sm" placeholder="Название">
              <input id="pv-company" class="input-sm" placeholder="Компания">
              <input id="pv-place" class="input-sm" placeholder="Адрес">
              <input id="pv-manager" class="input-sm" placeholder="Телефон менеджера">
            </div>
            <div class="pv-row">
              <input id="pv-dstart" type="date" class="input-sm">
              <input id="pv-dend"   type="date" class="input-sm">
              <input id="pv-tstart" type="time" class="input-sm">
              <input id="pv-tend"   type="time" class="input-sm">
            </div>
          </div>
          <div class="pv-row" style="margin-top:8px;grid-template-columns:1fr 1fr">
            <input id="pv-amount" class="input-sm" type="number" placeholder="Сумма (UZS)">
            <input id="pv-status" class="input-sm" placeholder="Статус">
          </div>
          <div class="pv-actions"><button id="pv-save" class="btn primary">Сохранить изменения</button></div>
        </div>

        <div class="pv-card">
          <h4 class="pv-title">Участники проекта</h4>
          <div class="ppl-controls">
            <input id="ppl-search" class="input-sm" placeholder="Поиск по имени или телефону" style="max-width:280px">
            <button id="ppl-add" class="btn ghost" type="button">+ Добавить участника</button>
            <span class="muted" id="ppl-count"></span>
          </div>
          <div style="overflow:auto">
            <table class="ppl-table">
              <thead><tr><th>#</th><th>Имя</th><th>Телефон (UZ)</th><th>Индивидуальная ссылка</th><th>Действия</th></tr></thead>
              <tbody id="ppl-tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-actions"><button type="button" class="btn ghost" id="cancel-view">Закрыть</button></div>
  </div>
</div>

<script>
/* ---------- Tabs ---------- */
const tabs=document.querySelectorAll('.tab');
const sections=document.querySelectorAll('.section');
tabs.forEach(t=>t.addEventListener('click',()=>{
  tabs.forEach(x=>x.classList.remove('active')); t.classList.add('active');
  const target=t.dataset.target; sections.forEach(s=>s.classList.toggle('active',s.id===target));
}));

/* ---------- Utils ---------- */
const FEEDBACK_BASE = (location.origin && location.origin!=='null' ? location.origin : 'https://example.com') + '/feedback/';
const rand = (n)=>Math.floor(Math.random()*n);
const token = (len=14)=>{ const c='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789'; let s=''; for(let i=0;i<len;i++) s+=c[rand(c.length)]; return s; };
const uzCodes = ['90','91','93','94','95','97','98','99','33','88'];
function randomUzPhone(){ const code=uzCodes[rand(uzCodes.length)], n=String(Math.floor(1_000_000+Math.random()*9_000_000)); return `+998 ${code} ${n.slice(0,3)}-${n.slice(3,5)}-${n.slice(5)}`; }
const firstNames = ['Aziz','Alisher','Madina','Gulnora','Jasur','Sevara','Nigora','Javlon','Sardor','Umid','Shahzoda','Murod','Diyora','Kamola','Sherzod','Iroda','Shaxzod','Muxlisa','Akmal','Dilshod','Sitora','Otabek','Lola','Doston','Maftuna','Javohir','Malika','Bekzod','Nozima','Said','Jahongir','Zarina','Shahnoza','Bobur'];
function randomName(){ return firstNames[rand(firstNames.length)]; }

/* ---------- Data store ---------- */
let projects = [
  seedProject(1,'Design Summit 2025','BlueWave Events','г. Ташкент, Истиқлол, 10','+998 90 123-45-67','2025-05-12','2025-05-13','09:00','18:00',12000000,'Черновик', rand(10)+12),
  seedProject(2,'Startup Meetup','Rocket Group','г. Ташкент, Амир Темур, 25','+998 97 765-43-21','2025-07-02','2025-07-02','18:30','21:00',3500000,'Опубликован', rand(10)+10),
];
function seedProject(id,name,company,place,manager,ds,de,ts,te,amount,status,peopleCount){
  const participants=[]; const n=peopleCount??(10+rand(21));
  for(let i=0;i<n;i++) participants.push({ id:i+1, name:randomName(), phone:randomUzPhone(), token:token() });
  return { id, name, company, place, manager_phone:manager, date_start:ds, date_end:de, time_start:ts, time_end:te, amount, status, speakers:[], participants };
}

/* ---------- Projects table ---------- */
const tbody = document.getElementById('projects-tbody');
function renderProjectsTable(){
  tbody.innerHTML='';
  projects.forEach((p,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${idx+1}</td>
      <td><span class="linkish" data-open="${p.id}">${p.name}</span></td>
      <td>${p.date_start||'—'} — ${p.date_end||'—'}</td>
      <td>${p.time_start||'—'} — ${p.time_end||'—'}</td>
      <td>${p.amount?Number(p.amount).toLocaleString('ru-RU')+' UZS':'—'}</td>
      <td>${p.company||'—'}</td>
      <td>${p.participants.length}</td>
      <td class="action-cell"><button class="btn ghost" data-edit="${p.id}" title="Открыть/изменить">✏️</button></td>`;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('[data-open]').forEach(el=>el.addEventListener('click',()=>openProjectView(Number(el.dataset.open))));
  tbody.querySelectorAll('[data-edit]').forEach(el=>el.addEventListener('click',()=>openProjectView(Number(el.dataset.edit))));
}
renderProjectsTable();

/* ---------- Analytics (как раньше) ---------- */
const analyticsData = {
  companies: [
    { company: 'BlueWave Events', ratings: [8,9,7,9,8] },
    { company: 'Rocket Group',   ratings: [7,6,8,8,7,9] },
    { company: 'Nova Media',     ratings: [9,9,8,9] }
  ],
  speakers: [
    { speaker: 'Alice Kim', ratings: [9,8,9,10] },
    { speaker: 'Boris Ivanov', ratings: [7,7,8] },
    { speaker: 'Chen Li', ratings: [8,9,9,9,8] }
  ],
  projects: [
    { project: 'Design Summit 2025', ratings: [8,9,8,9,7] },
    { project: 'Startup Meetup', ratings: [7,8,8,7] },
    { project: 'AI Expo', ratings: [9,9,9] }
  ]
};
function metric(sum,n){ return n?(sum/365)/n:0; }
function avg(arr){ return arr.length? arr.reduce((a,b)=>a+b,0)/arr.length : 0; }
function renderBars(containerId, rows, labelKey, valueFn){
  const cont=document.getElementById(containerId);
  cont.innerHTML='';
  if(!rows.length){ cont.textContent='Нет данных'; return; }
  const vals=rows.map(valueFn), max=Math.max(...vals,1);
  rows.map((r,i)=>({r,val:vals[i]})).sort((a,b)=>b.val-a.val).forEach(({r,val})=>{
    const wrap=document.createElement('div'); wrap.className='bar';
    const label=document.createElement('div'); label.className='bar-label'; label.textContent=r[labelKey];
    const track=document.createElement('div'); track.className='bar-track';
    const fill=document.createElement('div'); fill.className='bar-fill'; fill.style.width=(val/max*100).toFixed(1)+'%';
    const v=document.createElement('div'); v.className='bar-value'; v.textContent=val.toFixed(3);
    track.appendChild(fill); wrap.append(label, track, v); cont.appendChild(wrap);
  });
}
function recalcAnalytics(){
  renderBars('bars-companies', analyticsData.companies, 'company', r=>metric(r.ratings.reduce((a,b)=>a+b,0), r.ratings.length));
  renderBars('bars-speakers',  analyticsData.speakers,  'speaker', r=>metric(r.ratings.reduce((a,b)=>a+b,0), r.ratings.length));
  renderBars('bars-projects',  analyticsData.projects,  'project', r=>avg(r.ratings));
}
recalcAnalytics();

/* ---------- Create Project modal ---------- */
const mCreate = document.getElementById('modal-create');
const btnNew   = document.getElementById('btn-new');
const btnCloseCreate = document.getElementById('close-create');
const btnCancelCreate = document.getElementById('cancel-create');
btnNew.addEventListener('click', ()=>{ mCreate.classList.add('show'); document.body.style.overflow='hidden'; ensureOneRowDefaults(); });
[btnCloseCreate, btnCancelCreate].forEach(b=>b.addEventListener('click', ()=>{ mCreate.classList.remove('show'); document.body.style.overflow=''; }));
mCreate.addEventListener('click', (e)=>{ if(e.target===mCreate) { mCreate.classList.remove('show'); document.body.style.overflow=''; } });

/* dynamic rows in Create */
const speakersList=document.getElementById('speakers-list');
const participantsList=document.getElementById('participants-list');
document.getElementById('add-speaker').addEventListener('click', ()=>addSpeakerRow());
document.getElementById('add-participant').addEventListener('click', ()=>addParticipantRow());
function ensureOneRowDefaults(){ if(!document.querySelector('.speaker-row')) addSpeakerRow(); if(!document.querySelector('.participant-row')) addParticipantRow(); }
function addSpeakerRow(nameVal='', topicVal=''){
  const row=document.createElement('div'); row.className='row-grid speaker-row';
  row.innerHTML=`<input type="text" placeholder="Имя спикера" value="${nameVal}"><input type="text" placeholder="Тема выступления" value="${topicVal}"><button class="remove" type="button" aria-label="Удалить">🗑</button>`;
  row.querySelector('.remove').onclick=()=>row.remove(); speakersList.appendChild(row);
}
function addParticipantRow(nameVal='', phoneVal=''){
  const row=document.createElement('div'); row.className='row-grid participants participant-row';
  row.innerHTML=`<input type="text" placeholder="Имя участника" value="${nameVal}"><input type="tel" placeholder="+998 (__) ___-__-__" value="${phoneVal}" pattern="^\\+?\\d[\\d\\s\\-()]{6,}$" title="Введите корректный номер"><button class="remove" type="button" aria-label="Удалить">🗑</button>`;
  row.querySelector('.remove').onclick=()=>row.remove(); participantsList.appendChild(row);
}

/* submit create */
document.getElementById('project-form').addEventListener('submit', (e)=>{
  e.preventDefault();
  const payload={
    id: (projects.at(-1)?.id || 0) + 1,
    name: val('#p-name'), company: val('#p-company'),
    place: val('#p-place'), manager_phone: val('#p-manager-phone'),
    date_start: val('#p-date-start'), date_end: val('#p-date-end'),
    time_start: val('#p-time-start'), time_end: val('#p-time-end'),
    amount: Number(val('#p-amount')||0), status: val('#p-status') || 'Черновик',
    speakers: rows('.speaker-row').map(r=>({name:r.a, topic:r.b})),
    participants: rows('.participant-row').map((r,i)=>({id:i+1, name:r.a, phone:r.b, token:token()})),
  };
  if(payload.participants.length===0){ const n=10+rand(21); for(let i=0;i<n;i++){ payload.participants.push({id:i+1, name:randomName(), phone:randomUzPhone(), token:token()}); } }
  projects.push(payload);
  renderProjectsTable();
  e.target.reset(); speakersList.innerHTML=''; participantsList.innerHTML='';
  mCreate.classList.remove('show'); document.body.style.overflow='';
  openProjectView(payload.id);
});
const val=sel=>document.querySelector(sel).value.trim();
const rows=sel=>Array.from(document.querySelectorAll(sel)).map(r=>({a:r.children[0].value.trim(), b:r.children[1].value.trim()}));

/* ---------- Project View modal ---------- */
const mView = document.getElementById('modal-view');
const btnCloseView = document.getElementById('close-view');
const btnCancelView = document.getElementById('cancel-view');
[btnCloseView, btnCancelView].forEach(b=>b.addEventListener('click', closeProjectView));
mView.addEventListener('click', (e)=>{ if(e.target===mView) closeProjectView(); });
function closeProjectView(){ mView.classList.remove('show'); document.body.style.overflow=''; }

let currentProjectId = null;
function openProjectView(id){
  const p = projects.find(x=>x.id===id); if(!p) return;
  currentProjectId = id;
  document.getElementById('modal-title-view').textContent = `Проект: ${p.name}`;
  byId('pv-name').value = p.name || '';
  byId('pv-company').value = p.company || '';
  byId('pv-place').value = p.place || '';
  byId('pv-manager').value = p.manager_phone || '';
  byId('pv-dstart').value = p.date_start || '';
  byId('pv-dend').value   = p.date_end || '';
  byId('pv-tstart').value = p.time_start || '';
  byId('pv-tend').value   = p.time_end || '';
  byId('pv-amount').value = p.amount || '';
  byId('pv-status').value = p.status || '';
  renderPeopleTable(p.participants);
  mView.classList.add('show'); document.body.style.overflow='hidden';
}
function byId(id){ return document.getElementById(id); }

/* save overview */
document.getElementById('pv-save').addEventListener('click', ()=>{
  const p = projects.find(x=>x.id===currentProjectId); if(!p) return;
  p.name = byId('pv-name').value.trim();
  p.company = byId('pv-company').value.trim();
  p.place = byId('pv-place').value.trim();
  p.manager_phone = byId('pv-manager').value.trim();
  p.date_start = byId('pv-dstart').value;
  p.date_end   = byId('pv-dend').value;
  p.time_start = byId('pv-tstart').value;
  p.time_end   = byId('pv-tend').value;
  p.amount     = Number(byId('pv-amount').value||0);
  p.status     = byId('pv-status').value.trim() || 'Черновик';
  renderProjectsTable();
  alert('Сохранено (демо).');
});

/* people table */
const pplTbody = document.getElementById('ppl-tbody');
const pplSearch = document.getElementById('ppl-search');
const pplCount = document.getElementById('ppl-count');
document.getElementById('ppl-add').addEventListener('click', ()=>{
  const p = projects.find(x=>x.id===currentProjectId); if(!p) return;
  const nextId = (p.participants.at(-1)?.id || 0) + 1;
  p.participants.push({ id: nextId, name: randomName(), phone: randomUzPhone(), token: token() });
  renderPeopleTable(p.participants);
});
pplSearch.addEventListener('input', ()=>{
  const p = projects.find(x=>x.id===currentProjectId); if(!p) return;
  const q = pplSearch.value.trim().toLowerCase();
  const filtered = p.participants.filter(pp => (pp.name||'').toLowerCase().includes(q) || (pp.phone||'').toLowerCase().includes(q));
  renderPeopleTable(filtered, true);
});

function renderPeopleTable(list, filtered=false){
  pplTbody.innerHTML='';
  const p = projects.find(x=>x.id===currentProjectId); if(!p) return;
  const arr = list || p.participants;
  arr.forEach((u, i)=>{
    const tr=document.createElement('tr');
    const link = FEEDBACK_BASE + u.token;
    tr.innerHTML = `
      <td>${i+1}</td>
      <td><input class="input-sm" value="${u.name||''}" data-field="name" data-id="${u.id}"></td>
      <td><input class="input-sm" value="${u.phone||''}" data-field="phone" data-id="${u.id}"></td>
      <td>
        <div style="display:flex;gap:6px;align-items:center">
          <input class="input-sm" value="${link}" readonly style="flex:1;min-width:260px">
          <button class="copy-btn" data-copy="${u.id}">Copy</button>
          <button class="regen-btn" data-regen="${u.id}">Regen</button>
        </div>
      </td>
      <td><button class="sms-btn" data-sms="${u.id}">SMS</button></td>`;
    pplTbody.appendChild(tr);
  });
  pplCount.textContent = `Всего: ${filtered ? arr.length + ' (из ' + p.participants.length + ')' : p.participants.length}`;

  pplTbody.querySelectorAll('input[data-field]').forEach(inp=>{
    inp.addEventListener('change', ()=>{
      const id = Number(inp.dataset.id);
      const field = inp.dataset.field;
      const user = p.participants.find(x=>x.id===id);
      if(user){ user[field] = inp.value.trim(); }
    });
  });
  pplTbody.querySelectorAll('[data-copy]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id=Number(btn.dataset.copy);
      const user=p.participants.find(x=>x.id===id); if(!user) return;
      const link = FEEDBACK_BASE + user.token;
      navigator.clipboard?.writeText(link);
      btn.textContent='Copied'; setTimeout(()=>btn.textContent='Copy',1000);
    });
  });
  pplTbody.querySelectorAll('[data-regen]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id=Number(btn.dataset.regen);
      const user=p.participants.find(x=>x.id===id); if(!user) return;
      user.token = token();
      renderPeopleTable(p.participants);
    });
  });
  pplTbody.querySelectorAll('[data-sms]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id=Number(btn.dataset.sms);
      const user=p.participants.find(x=>x.id===id); if(!user) return;
      alert(`Демо: отправили SMS на ${user.phone}\nСсылка: ${FEEDBACK_BASE+user.token}`);
    });
  });
}
</script>
</body>
</html>
